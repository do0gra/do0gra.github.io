---
layout: post
---

[back](./)

# Analysing an AutoIT malware

This post details the steps taken to analyse an AutoIT malware.
![execution_flow](/assets/images/autoit_malware/autoit_execution_flow.png)

## De-obfuscating batch script 
* Remove lines that does not contain batch commands eg. set, cmd, finds 
* Replace strings with randomly generated names with its "set" value eg. replace strings shNfHOJQ..... with r
* Remove the "%" character for strings that were replaced and encapsulated by %

### Before de-obfuscation:
![batch_obfuscated](/assets/images/autoit_malware/autoit_batch_obf.png)

### After de-obfuscation:
![batch_deobfuscated](/assets/images/autoit_malware/autoit_batch_deobf.png)

* The script checks if any of the anti-viruses Avast, AVG, Norton and Sophos is running in the machine. If is not, it renames the AutoIT executable that was dropped to AutoIt3.exe and renames the dropped AutoIT script to .a3x
* The next thing it checks is if Webroot SecureAnywhere is running in the machine. If it is not, it performs 210 pings to localhost
* The remaining action is as shown in the execution flow:
*	Files "Tractor", "Standard", "Feb", "Disclaimer", "Demonstration" and "Convertible" are merged to create the AutoIT executable
*	Files "Experiment", "Dependent" and "Dramatic" are merged to produce the obfuscated AutoIT script

## De-obfuscating AutoIT script

### Before de-obfuscating strings:
![autoit_script1](/assets/images/autoit_malware/autoit_script1.png)

* Notice that there are multiple calls to the function "Spyware"

### The strings de-obfuscation function:
![autoit_script2](/assets/images/autoit_malware/autoit_script2.png)

* Focusing on the lines that were highlighted:
	* The first argument is "split" into an array delimited by the '%' character. Each item in the array is deducted by the second argument and converted to unicode character

### After de-obfuscating strings:
![autoit_script3](/assets/images/autoit_malware/autoit_script3.png)

* The de-obfuscated strings as shown above (these strings shown here have no meaning because these are all junk code)

## Extracting the embedded file

* A large binary blob is embedded in the script and assigned to the variable (pNseF)
