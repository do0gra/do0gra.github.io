---
layout: post
---

[back](./)

# Analysing an AutoIT malware

This post details the steps taken to analyse an AutoIT malware.
![execution_flow](/assets/images/autoit_malware/autoit_execution_flow.png)

## De-obfuscating batch script 
* Remove lines that does not contain batch commands eg. set, cmd, finds 
* Replace strings with randomly generated names with its "set" value eg. replace strings shNfHOJQ..... with r
* Remove the "%" character for strings that were replaced and encapsulated by %

### Before de-obfuscation:
![batch_obfuscated](/assets/images/autoit_malware/autoit_batch_obf.png)

### After de-obfuscation:
![batch_deobfuscated](/assets/images/autoit_malware/autoit_batch_deobf.png)

* The script checks if any of the anti-viruses Avast, AVG, Norton and Sophos is running in the machine. If is not, it renames the AutoIT executable that was dropped to AutoIt3.exe and renames the dropped AutoIT script to .a3x
* The next thing it checks is if Webroot SecureAnywhere is running in the machine. If it is not, it performs 210 pings to localhost
* The remaining action is as shown in the execution flow:
* Files "Tractor", "Standard", "Feb", "Disclaimer", "Demonstration" and "Convertible" are merged to create the AutoIT executable
* Files "Experiment", "Dependent" and "Dramatic" are merged to produce the obfuscated AutoIT script

## De-obfuscating AutoIT script

### Before de-obfuscating strings:
![autoit_script1](/assets/images/autoit_malware/autoit_script1.png)

* Notice that there are multiple calls to the function "Spyware"

### The strings de-obfuscation function:
![autoit_script2](/assets/images/autoit_malware/autoit_script2.png)

* Focusing on the lines that were highlighted:
	* The first argument is "split" into an array delimited by the '%' character. Each item in the array is deducted by the second argument and converted to unicode character

### After de-obfuscating strings:
![autoit_script3](/assets/images/autoit_malware/autoit_script3.png)

* The de-obfuscated strings as shown above (these strings shown here have no meaning because these are all junk code)

## Extracting the embedded file

* A large binary blob is embedded in the script and assigned to the variable (pNseF)
![binary_blob](/assets/images/autoit_malware/binary_blob.png)

* Tracing where this variable is used, it is passed as a first argument to the function "Nickpot"
![nickpot](/assets/images/autoit_malware/nickpot.png)

## Analyzing the "Nickpot" function

* Analyzing the function, there is another binary blob "ConnectionsEquality" and its value depend on whether a 32-bit or 64-bit AutoIt executable is used. We shall examine this "ConnectionsEquality" binary blob assuming x64 architecture since it will help to unveil the bigger binary blob.
![binary_blob2](/assets/images/autoit_malware/binary_blob2.png)

## Analyzing the "ConnectionsEquality" blob (Focusing on x64 version)

* Extracting the 64-bit value of "ConnectionsEquality" into a hex editor and decompiling it results in the following (seems to be some form of 
encryption/decryption function) :

![decryption_stub](/assets/images/autoit_malware/decryption_stub.png)

* Now that we know "ConnectionsEquality" is some kind of encryption/decryption function, to find how it was used, we can trace where this variable is called and what arguments are passed to it

* Tracing where "ConnectionsEquality" is used, the content of the variable is copied to the variable "hiltonfinalsdirectories"

![setstruct_1](/assets/images/autoit_malware/setstruct_1.png)

* Tracing where "hiltonfinalsdirectories" is used, its called via the DllCallAddress with the following being passed as arguments to it: Pointer to 
structure "QualifiedRefugeesCattle", Pointer to structure "DETAILWITNESS", "TreatmentsPicked

![dllcalladdress1](/assets/images/autoit_malware/dllcalladdress1.png)

* "QualifiedRefugeesCattle" is an empty structure with length 272 bytes

![dllstructcreate1](/assets/images/autoit_malware/dllstructcreate1.png)

* "strapthumbgeniusroll" is a structure that contents the content of "strapthumbgeniusroll", which is the 2nd argument to the function "Nickpot"

![dllstructsetdata1](/assets/images/autoit_malware/dllstructsetdata1.png)

* "TreatmentsPicked" contains the length of "strapthumbgeniusroll"

![binlen1](/assets/images/autoit_malware/binlen1.png)

* To summarise what is happening thus far, the function "ConnectionsEquality" sets the data of "QualifiedRefugeesCattle" depending 
on the value of "DETAILWITNESS"

## Analyzing where "QualifiedRefugeesCattle" is used

* "QualifiedRefugeesCattle" is used here as a first argument here. The other two arguments here "DETAILWITNESS2" and "TreatmentsPicked2"

![dllcalladdress2](/assets/images/autoit_malware/dllcalladdress2.png)

* Tracing the other two arguments: "DETAILWITNESS2" contains the data of the first argument to the "Nickpot" function and "TreatmentsPicked2" 
contains the length of it

![dllstructsetdata2](/assets/images/autoit_malware/dllstructsetdata2.png)

![binlen2](/assets/images/autoit_malware/binlen2.png)

* To summarise what is happening here, "DETAILWITNESS2" is modified based on the data of "QualifiedRefugeesCattle"

## Analyzing what is returned at the end of "Nickpot"

* The function "MarcoCindy" just returns the data of "DETAILWITNESS2" as a structure

![return](/assets/images/autoit_malware/return.png)

### Analyzing the "FishVerzeichnisBobby" function

![func](/assets/images/autoit_malware/func.png)

![dllstructsetdata3](/assets/images/autoit_malware/dllstructsetdata3.png)

![dllcall](/assets/images/autoit_malware/dllcall.png)

* Summarizing the above, the data "DETAILWITNESS2" (called SquirtingNcaaTnAj in this function) is saved into the structure  "elegantacknowledge" and passed as an argument to the WINAPI function "RtlDecompressFragment"

* Looking up the "RtlDecompressFragment" function on MSDN:
![rtlcompressfragment](/assets/images/autoit_malware/rtlcompressfragment.png)


* The function decompresses part of "elegantacknowledge" and saves the result in "transmissionsetpromptlylab"
* We get the PE file (SHA1:b5c8cf1839ae8454711885fa8116df0c2252dc6f) by dumping the variable "transmissionsetpromptlylab" at this point
This file was flagged by WIndows Defender as LummaStealer