---
layout: post
title: "AST-Based Detection of JavaScript Malware Families"
---

[back](./)


# Background

While researching **GOOTLOADER**, I came across an excellent project by Karsten Hahn:  
ðŸ‘‰ https://github.com/struppigel/hedgehog-tools/tree/main/gootloader  
This tool unpacks and extracts C2 infrastructure from GOOTLOADER samples.

At the same time, I was also analyzing other JavaScript-based malware families, including **BALADA Injector** and **Parrot TDS / SocGholish**. For dealing with their heavily obfuscated JavaScript payloads, I relied on the powerful deobfuscation tool **WebCrack**:  
ðŸ‘‰ https://github.com/j4k0xb/webcrack

This led me to the idea of combining both approachesâ€”detection and deobfuscationâ€”into a single pipeline. The resulting script accepts a JavaScript file, detects the malware family based on Abstract Syntax Tree (AST) patterns, and then applies a family-specific deobfuscation and IOC extraction routine.


# Detection Rules

Detection is performed by parsing the input JavaScript into an AST and evaluating against known structural signatures observed in real-world samples. Below are the heuristics used to differentiate malware families.

## Gootloader

Identified by the structure of the top-level function declaration:

- Root node contains:
  - A single argument.
  - Argument is of type `NumericLiteral`.
- The function name:
  - Has a length â‰¤ 10 characters.
  - Does **not** contain underscores.

<!--- 

Starting node has:
	- Only 1 argument
	- Argument is of NumericLiteral type 
	- Function has a name where length is less than or equal 10 and does not include underscore

-->


## ParrotTDS / SocGholish

Characterized by anti-analysis checks involving `typeof` and `undefined` comparisons:

- Contains an `IfStatement` with:
  - A strict equality comparison (`===`).
  - Expressions such as:
    - Left-hand side: `typeof ndsj` or `typeof ndsw`; Right-hand side: string `"undefined"`.
    - Left-hand side: identifier `ndsj` or `ndsw`; Right-hand side: identifier `undefined`.

<!-- 
- Has an ifstatement with the following properties:
	- Uses "===" as an operator
	- One (or more) of the following expressions: 
		- Left side of expression contains the operator "typeof" with argument name "ndsj" or "ndsw" and Right side of expression contains the string value "undefined"
		- Left side of expression contains the identifier name "ndsj" or ndsw" and Right side of expression  contains the identifier name "undefined"  
-->

## Balada injector

Detected through event hooking behavior:
- Presence of a `CallExpression` with:
  - Callee name: `sgAddEvent`
  - Arguments:
    1. `"window"` (string literal)
    2. `"sgpbWillOpen"` (string literal)
    3. A `FunctionExpression` type

<!--
- Checks if there is a call expression with name "sgAddEvent" with the following as arguments:
	- First argument with string name of "window" 
	- Second argument with value "sgpbWillOpen"
	- Third argument is a a function expression type
-->

# Evaluation & Results
To validate the approach, I gathered a dataset of confirmed samples for each family from VirusTotal and ran them through the detection and extraction script.

### GOOTLOADER Detection Output

![gootloader_scn](/assets/images/identify_script/gootloader_scn.png)

### ParrotTDS / SocGholish Detection Output

![parrottds_scn](/assets/images/identify_script/parrottds_scn.png)

### BALADA Injector Detection Output

![balada_scn](/assets/images/identify_script/balada_scn.png)


# Conclusion

This proof-of-concept demonstrates the viability of AST-based heuristics in detecting and triaging obfuscated JavaScript malware. The next steps include expanding detection rules for other families and integrating IOC enrichment from deobfuscated payloads.

Feel free to explore the tools that inspired this project:
- [Hedgehog Tools by @struppigel](https://github.com/struppigel/hedgehog-tools/tree/main/gootloader)
- [WebCrack by @j4k0xb](https://github.com/j4k0xb/webcrack)
