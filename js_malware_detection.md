---
layout: post
---

[back](./)


# Background
While researching on GOOTLOADER, I came across this project written by Karsten Hahn https://github.com/struppigel/hedgehog-tools/tree/main/gootloader that unpacks and extracts C2 addresses. At the same time, I was also analysing other javascript-based malware like BALADA and Parrot TDS/SocGholish. For heavily obfuscated javascripts, I use this awesome tool https://github.com/j4k0xb/webcrack that de-obfuscates most of the samples I came across. I then had the idea of combining both projects into one that would be able to take in a javascript file which first detect the type of malware family based on its AST, then depending on the malware family, deobfuscate and extract the IOCs.

# Detection Rules
Based on current malware family trends.

## Gootloader
- Starting node has:
	- Only 1 argument
	- Argument is of NumericLiteral type 
	- Function has a name where length is less than or equal 10 and does not include underscore


## ParrotTDS
- Has an ifstatement with the following properties:
	- Uses "===" as an operator
	- One (or more) of the following expressions: 
		- Left side of expression contains the operator "typeof" with argument name "ndsj" or "ndsw" and Right side of expression contains the string value "undefined"
		- Left side of expression contains the identifier name "ndsj" or ndsw" and Right side of expression  contains the identifier name "undefined"  

## Balada injector
- Checks if there is a call expression with name "sgAddEvent" with the following as arguments:
	- First argument with string name of "window" 
	- Second argument with value "sgpbWillOpen"
	- Third argument is a a function expression type

# Results
To test the script, I downloaded samples from VirusTotal for each family and ran the script against it. 

SCREENSHOTS HERE!